{"version":3,"sources":["file:///Users/qinx/coding/cocos2dx/Cocos2dx-taxi/assets/script/game/CustomerManager.ts"],"names":["_decorator","Component","Node","Vec3","AnimationComponent","Constants","CustomEventListener","AudioManager","ccclass","property","EventName","_tempVec","CustomerManager","type","CustomerState","NONE","start","on","GREETING","_greetingCustomer","GOODBYE","_takingCustomer","update","dt","_inTheOrder","_deltaTime","walkTime","_curCustomer","active","_state","playSound","AudioSource","INCAR","dispatchEvent","FINISHID_WALK","lerp","_startPos","_endPos","setWorldPosition","args","customers","Math","floor","random","length","carPos","direction","multiplyScalar","add","x","eulerAngles","z","animComp","getComponent","play","GETMONEY"],"mappings":"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","sourcesContent":["\nimport { _decorator, Component, Node, Vec3, AnimationComponent, TERRAIN_HEIGHT_BASE } from 'cc';\nimport { Constants } from '../data/Constants';\nimport { CustomEventListener } from '../data/CustomEventListener';\nimport { AudioManager } from './AudioManager';\nconst { ccclass, property } = _decorator;\n\nconst EventName = Constants.EventName;\nconst _tempVec = new Vec3()\n\n@ccclass('CustomerManager')\nexport class CustomerManager extends Component {\n\n  @property({\n    type: [Node]\n  })\n  customers: Node[] = [];\n\n  @property\n  walkTime = 2;\n\n  private _curCustomer: Node | null = null;\n  private _startPos = new Vec3();\n  private _endPos = new Vec3();\n  private _inTheOrder = false;\n  private _deltaTime = 0;\n  private _state = Constants.CustomerState.NONE;\n\n  public start() {\n    CustomEventListener.on(EventName.GREETING, this._greetingCustomer, this);\n    CustomEventListener.on(EventName.GOODBYE, this._takingCustomer, this);\n  }\n\n  public update(dt: number) {\n    if (this._inTheOrder) {\n      this._deltaTime += dt;\n      if (this._deltaTime > this.walkTime) {\n        this._deltaTime = 0;\n        this._inTheOrder = false;\n        this._curCustomer!.active = false;\n        if (this._state == Constants.CustomerState.GOODBYE) {\n          this._curCustomer = null;\n        }\n\n        if (this._state === Constants.CustomerState.GREETING) {\n          AudioManager.playSound(Constants.AudioSource.INCAR);\n        }\n\n        CustomEventListener.dispatchEvent(EventName.FINISHID_WALK);\n      } else {\n        Vec3.lerp(_tempVec, this._startPos, this._endPos, this._deltaTime / this.walkTime)\n        this._curCustomer?.setWorldPosition(_tempVec);\n      }\n    }\n  }\n\n  private _greetingCustomer(...args: any[]) {\n    this._curCustomer = this.customers[Math.floor(Math.random() * this.customers.length)];\n    this._state = Constants.CustomerState.GREETING;\n    this._inTheOrder = true;\n    if (!this.customers) {\n      return;\n    }\n\n    const carPos = args[0];\n    const direction = args[1];\n    Vec3.multiplyScalar(this._startPos, direction, 1.4);\n    this._startPos.add(carPos)\n    Vec3.multiplyScalar(this._endPos, direction, 0.5);\n    this._endPos.add(carPos)\n\n    this._curCustomer.setWorldPosition(this._startPos);\n    this._curCustomer.active = true\n\n    if (direction.x !== 0) {\n      // 设置朝向\n      if (direction.x > 0) {\n        this._curCustomer.eulerAngles = new Vec3(0, -90, 0);\n      } else {\n        this._curCustomer.eulerAngles = new Vec3(0, 90, 0);\n      }\n    } else {\n      if (direction.z > 0) {\n        this._curCustomer.eulerAngles = new Vec3(0, 180, 0);\n      } else {\n        this._curCustomer.eulerAngles = new Vec3();\n      }\n    }\n\n    const animComp = this._curCustomer.getComponent(AnimationComponent);\n    animComp.play('walk');\n\n  }\n\n  private _takingCustomer(...args: any[]) {\n    this._state = Constants.CustomerState.GOODBYE;\n    this._inTheOrder = true;\n\n    const carPos = args[0];\n    const direction = args[1];\n    Vec3.multiplyScalar(this._startPos, direction, 0.5);\n    this._startPos.add(carPos)\n    Vec3.multiplyScalar(this._endPos, direction, 1.4);\n    this._endPos.add(carPos)\n\n    this._curCustomer.setWorldPosition(this._startPos);\n    this._curCustomer.active = true\n\n    if (direction.x !== 0) {\n      // 设置朝向\n      if (direction.x > 0) {\n        this._curCustomer.eulerAngles = new Vec3(0, 90, 0);\n      } else {\n        this._curCustomer.eulerAngles = new Vec3(0, -90, 0);\n      }\n    } else {\n      if (direction.z > 0) {\n        this._curCustomer.eulerAngles = new Vec3();\n      } else {\n        this._curCustomer.eulerAngles = new Vec3(0, 180, 0);\n      }\n    }\n\n    const animComp = this._curCustomer.getComponent(AnimationComponent);\n    animComp.play('walk');\n    AudioManager.playSound(Constants.AudioSource.GETMONEY);\n  }\n}\n\n\n"]}