{"version":3,"sources":["file:///Users/qinx/coding/cocos2dx/Cocos2dx-taxi/assets/script/game/CarManager.ts"],"names":["_decorator","Component","Node","loader","Prefab","Vec3","Constants","CustomEventListener","PoolManager","RoadPoint","Car","ccclass","property","CarManager","type","start","on","EventName","GAME_OVER","_gameOver","reset","points","length","console","warn","_recycleAllAICar","_curPath","_createMainCar","_startSchedule","controMoving","isRunning","dispatchEvent","SHOW_GUIDE","mainCar","startRunning","stopRunning","setEntry","setCamera","camera","cameraPos","cameraRotation","_stopSchedule","stopImmediately","setParent","node","parent","i","_aiCars","car","roadPoint","getComponent","startSchedule","_createEnemy","bind","stopSchedule","road","carID","self","loadRes","err","prefab","getNode","carComp","push","maxSpeed","speed","moveAfterFinished","_recycleAICae","index","indexOf","setNode","splice"],"mappings":"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","sourcesContent":["\nimport { _decorator, Component, Node, loader, Prefab, Vec3 } from 'cc';\nimport { Constants } from '../data/Constants';\nimport { CustomEventListener } from '../data/CustomEventListener';\nimport { PoolManager } from '../data/PoolManager';\nimport { RoadPoint } from '../RoadPoint';\nimport { Car } from \"./Car\";\n\nconst { ccclass, property } = _decorator;\n\n@ccclass('CarManager')\nexport class CarManager extends Component {\n\n  @property({\n    type: Car\n  })\n  mainCar: Car | null = null;\n\n  @property({\n    type: Node\n  })\n  camera: Node = null!;\n\n  @property\n  cameraPos = new Vec3(0, 2, 2);\n\n  @property\n  cameraRotation = -40;\n\n  private _curPath: Node[] = [];\n  private _aiCars: Car[] = [];\n\n  public start() {\n    CustomEventListener.on(Constants.EventName.GAME_OVER, this._gameOver, this);\n  }\n\n  public reset(points: Node[]) {\n    if (points.length <= 0) {\n      console.warn(\"there is no points in this map\");\n      return;\n    }\n\n    this._recycleAllAICar();\n    this._curPath = points;\n    this._createMainCar(points[0]);\n    this._startSchedule();\n  }\n\n  public controMoving(isRunning = true) {\n    if (isRunning) {\n      CustomEventListener.dispatchEvent(Constants.EventName.SHOW_GUIDE, false);\n      this.mainCar?.startRunning();\n    } else {\n      this.mainCar?.stopRunning();\n    }\n  }\n\n  private _createMainCar(points: Node) {\n    this.mainCar!.setEntry(points, true);\n    this.mainCar?.setCamera(this.camera, this.cameraPos, this.cameraRotation);\n  }\n\n  private _gameOver() {\n    this._stopSchedule();\n    this.mainCar?.stopImmediately();\n    this.camera.setParent(this.node.parent, true);\n    for (let i = 0; i < this._aiCars.length; i++) {\n      const car = this._aiCars[i];\n      car.stopImmediately();\n    }\n  }\n\n  private _startSchedule() {\n    for (let i = 1; i < this._curPath.length; i++) {\n      const node = this._curPath[i]\n      const roadPoint = node.getComponent(RoadPoint);\n      roadPoint?.startSchedule(this._createEnemy.bind(this));\n    }\n  }\n\n  private _stopSchedule() {\n    for (let i = 1; i < this._curPath.length; i++) {\n      const node = this._curPath[i]\n      const roadPoint = node.getComponent(RoadPoint);\n      roadPoint?.stopSchedule();\n    }\n  }\n\n  private _createEnemy(road: RoadPoint, carID: string) {\n    const self = this;\n    loader.loadRes(`car/car${carID}`, Prefab, (err, prefab) => {\n      if (err) {\n        console.warn(err);\n        return;\n      }\n\n      const car = PoolManager.getNode(prefab, self.node);\n      const carComp = car.getComponent(Car) as Car;\n      this._aiCars.push(carComp);\n      carComp.setEntry(road.node)\n      carComp.maxSpeed = road.speed;\n      carComp.startRunning();\n      carComp.moveAfterFinished(this._recycleAICae.bind(this))\n    })\n  }\n\n  private _recycleAICae(car: Car) {\n    const index = this._aiCars.indexOf(car);\n    if (index >= 0) {\n      PoolManager.setNode(car.node);\n      this._aiCars.splice(index, 1);\n    }\n  }\n\n  private _recycleAllAICar() {\n    for (let i = 0; i < this._aiCars.length; i++) {\n      const car = this._aiCars[i];\n      PoolManager.setNode(car.node);\n    }\n\n    this._aiCars.length = 0;\n  }\n}"]}