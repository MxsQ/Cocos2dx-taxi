{"version":3,"sources":["file:///Users/qinx/coding/cocos2dx/Cocos2dx-taxi/assets/script/game/GameCtrl.ts"],"names":["_decorator","Component","Node","BoxCollider","loader","Prefab","instantiate","Constants","CustomEventListener","RunTimeData","LoadingUI","UIManager","AudioManager","CarManager","MapManager","ccclass","property","GameCtrl","type","onLoad","loadingUI","show","_loadMap","collider","group","getComponent","setGroup","CarGroup","NORMAL","setMask","start","showDialog","UIPage","mainUI","node","on","EventType","TOUCH_START","_touchStart","TOUCH_END","_touchEnd","EventName","GAME_START","_gameStart","GAME_OVER","_gameOver","NEW_LEVEL","_newLevel","playMusic","touch","event","carManager","controMoving","hidDialog","gameUI","resultUI","mapManager","recycle","_reset","resetMap","reset","curPath","runtimeData","instance","curProgress","maxProgress","level","cb","map","loadRes","err","prefab","console","warn","_progress","scheduleOnce","_loadingSchedule","mapNode","parent","finishLoading","dispatchEvent","UPDATE_PROGRESS"],"mappings":"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","sourcesContent":["\nimport { _decorator, Component, Node, EventTouch, BoxColliderComponent, BoxCollider, Vec3, loader, Prefab, instantiate } from 'cc';\nimport { Constants } from '../data/Constants';\nimport { CustomEventListener } from '../data/CustomEventListener';\nimport { RunTimeData } from '../data/GameData';\nimport { LoadingUI } from '../ui/LoadingUI';\nimport { UIManager } from '../ui/UIManager';\nimport { AudioManager } from './AudioManager';\nimport { CarManager } from './CarManager';\nimport { MapManager } from './MapManager';\nconst { ccclass, property } = _decorator;\n\n@ccclass('GameCtrl')\nexport class GameCtrl extends Component {\n  @property({\n    type: MapManager\n  })\n  mapManager: MapManager = null;\n\n  @property({\n    type: CarManager\n  })\n  carManager: CarManager = null;\n\n  @property({\n    type: Node,\n  })\n  group: Node = null!;\n\n  @property({\n    type: LoadingUI\n  })\n  loadingUI: LoadingUI = null;\n\n  private _progress = 5;\n\n  public onLoad() {\n    this.loadingUI.show();\n    this._loadMap(1);\n    const collider = this.group.getComponent(BoxCollider)!;\n    collider.setGroup(Constants.CarGroup.NORMAL);\n    collider.setMask(-1);\n  }\n\n  public start() {\n    UIManager.showDialog(Constants.UIPage.mainUI);\n\n    this.node.on(Node.EventType.TOUCH_START, this._touchStart, this);\n    this.node.on(Node.EventType.TOUCH_END, this._touchEnd, this);\n    CustomEventListener.on(Constants.EventName.GAME_START, this._gameStart, this);\n    CustomEventListener.on(Constants.EventName.GAME_OVER, this._gameOver, this);\n    CustomEventListener.on(Constants.EventName.NEW_LEVEL, this._newLevel, this);\n\n    AudioManager.playMusic();\n  }\n\n  private _touchStart(touch: Touch, event: EventTouch) {\n    this.carManager?.controMoving();\n  }\n\n  private _touchEnd(touch: Touch, event: EventTouch) {\n    this.carManager?.controMoving(false);\n  }\n\n\n  private _gameStart() {\n    UIManager.hidDialog(Constants.UIPage.mainUI);\n    UIManager.showDialog(Constants.UIPage.gameUI);\n  }\n\n  private _gameOver() {\n    UIManager.hidDialog(Constants.UIPage.gameUI);\n    UIManager.showDialog(Constants.UIPage.resultUI);\n  }\n\n  private _newLevel() {\n    UIManager.hidDialog(Constants.UIPage.resultUI);\n    UIManager.showDialog(Constants.UIPage.mainUI);\n    this.mapManager.recycle();\n    this.loadingUI.show();\n    this._loadMap(1);\n  }\n\n  private _reset() {\n    this.mapManager!.resetMap();\n    this.carManager!.reset(this.mapManager!.curPath);\n    const runtimeData = RunTimeData.instance();\n    runtimeData.curProgress = 0;\n    runtimeData.maxProgress = this.mapManager.maxProgress;\n  };\n\n  private _loadMap(level: number, cb?: Function) {\n    let map = `map/map`;\n    if (level >= 100) {\n      map += `${level}`;\n    } else if (level >= 10) {\n      map += `1${level}`;\n    } else {\n      map += `10${level}`;\n    }\n\n    loader.loadRes(map, Prefab, (err, prefab) => {\n      if (err) {\n        console.warn(err);\n        return;\n      }\n\n      this._progress = 5;\n      this.scheduleOnce(this._loadingSchedule, 0.2);\n      const mapNode = instantiate(prefab) as Node;\n      mapNode.parent = this.mapManager.node;\n      if (cb) {\n        cb();\n      }\n\n      this._progress = 0;\n      this._reset();\n      this.loadingUI.finishLoading();\n    })\n\n\n  }\n\n  private _loadingSchedule() {\n    if (this._progress < 0) {\n      return;\n    }\n\n    this._progress--;\n    CustomEventListener.dispatchEvent(Constants.EventName.UPDATE_PROGRESS, 40 / 5);\n    this.scheduleOnce(this._loadingSchedule, 0.2);\n  }\n}\n\n"]}