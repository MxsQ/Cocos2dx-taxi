{"version":3,"sources":["file:///Users/qinx/coding/cocos2dx/Cocos2dx-taxi/assets/script/game/GameCtrl.ts"],"names":["_decorator","Component","Node","BoxCollider","loader","Prefab","instantiate","Configuration","Constants","CustomEventListener","PlayerData","RunTimeData","LoadingUI","UIManager","AudioManager","CarManager","MapManager","ccclass","property","GameCtrl","type","onLoad","_runtimeData","instance","init","loadFromCache","loadingUI","show","_lastMapID","currLevel","_loadMap","collider","group","getComponent","setGroup","CarGroup","NORMAL","setMask","start","showDialog","UIPage","mainUI","node","on","EventType","TOUCH_START","_touchStart","TOUCH_END","_touchEnd","EventName","GAME_START","_gameStart","GAME_OVER","_gameOver","NEW_LEVEL","_newLevel","playMusic","touch","event","carManager","controMoving","hidDialog","gameUI","resultUI","_reset","mapManager","recycle","resetMap","reset","curPath","runtimeData","curProgress","maxProgress","money","level","cb","map","loadRes","err","prefab","console","warn","_progress","scheduleOnce","_loadingSchedule","mapNode","parent","finishLoading","dispatchEvent","UPDATE_PROGRESS"],"mappings":"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","sourcesContent":["\nimport { _decorator, Component, Node, EventTouch, BoxColliderComponent, BoxCollider, Vec3, loader, Prefab, instantiate } from 'cc';\nimport { Configuration } from '../data/Configuration';\nimport { Constants } from '../data/Constants';\nimport { CustomEventListener } from '../data/CustomEventListener';\nimport { PlayerData, RunTimeData } from '../data/GameData';\nimport { LoadingUI } from '../ui/LoadingUI';\nimport { UIManager } from '../ui/UIManager';\nimport { AudioManager } from './AudioManager';\nimport { CarManager } from './CarManager';\nimport { MapManager } from './MapManager';\nconst { ccclass, property } = _decorator;\n\n@ccclass('GameCtrl')\nexport class GameCtrl extends Component {\n  @property({\n    type: MapManager\n  })\n  mapManager: MapManager = null;\n\n  @property({\n    type: CarManager\n  })\n  carManager: CarManager = null;\n\n  @property({\n    type: Node,\n  })\n  group: Node = null!;\n\n  @property({\n    type: LoadingUI\n  })\n  loadingUI: LoadingUI = null;\n\n  private _progress = 5;\n  private _runtimeData: RunTimeData = null;\n  private _lastMapID = 0;\n\n  public onLoad() {\n    this._runtimeData = RunTimeData.instance();\n    Configuration.instance().init();\n    PlayerData.instance().loadFromCache();\n    this.loadingUI.show();\n    this._lastMapID == this._runtimeData.currLevel\n    this._loadMap(1);\n    const collider = this.group.getComponent(BoxCollider)!;\n    collider.setGroup(Constants.CarGroup.NORMAL);\n    collider.setMask(-1);\n  }\n\n  public start() {\n    UIManager.showDialog(Constants.UIPage.mainUI);\n\n    this.node.on(Node.EventType.TOUCH_START, this._touchStart, this);\n    this.node.on(Node.EventType.TOUCH_END, this._touchEnd, this);\n    CustomEventListener.on(Constants.EventName.GAME_START, this._gameStart, this);\n    CustomEventListener.on(Constants.EventName.GAME_OVER, this._gameOver, this);\n    CustomEventListener.on(Constants.EventName.NEW_LEVEL, this._newLevel, this);\n\n    AudioManager.playMusic();\n  }\n\n  private _touchStart(touch: Touch, event: EventTouch) {\n    this.carManager?.controMoving();\n  }\n\n  private _touchEnd(touch: Touch, event: EventTouch) {\n    this.carManager?.controMoving(false);\n  }\n\n\n  private _gameStart() {\n    UIManager.hidDialog(Constants.UIPage.mainUI);\n    UIManager.showDialog(Constants.UIPage.gameUI);\n  }\n\n  private _gameOver() {\n    UIManager.hidDialog(Constants.UIPage.gameUI);\n    UIManager.showDialog(Constants.UIPage.resultUI);\n  }\n\n  private _newLevel() {\n    UIManager.hidDialog(Constants.UIPage.resultUI);\n    UIManager.showDialog(Constants.UIPage.mainUI);\n    if (this._lastMapID === this._runtimeData.currLevel) {\n      this._reset();\n      return;\n    }\n\n    this.mapManager.recycle();\n    this.loadingUI.show();\n    this._lastMapID = this._runtimeData.currLevel;\n    this._loadMap(this._lastMapID);\n  }\n\n  private _reset() {\n    this.mapManager!.resetMap();\n    this.carManager!.reset(this.mapManager!.curPath);\n    const runtimeData = this._runtimeData;\n    runtimeData.curProgress = 0;\n    runtimeData.maxProgress = this.mapManager.maxProgress;\n    runtimeData.money = 0;\n  };\n\n  private _loadMap(level: number, cb?: Function) {\n    let map = `map/map`;\n    // if (level >= 100) {\n    //   map += `${level}`;\n    // } else if (level >= 10) {\n    //   map += `1${level}`;\n    // } else {\n    //   map += `10${level}`;\n    // }\n\n    loader.loadRes(`${map}101`, Prefab, (err, prefab) => {\n      if (err) {\n        console.warn(err);\n        return;\n      }\n\n      this._progress = 5;\n      this.scheduleOnce(this._loadingSchedule, 0.2);\n      const mapNode = instantiate(prefab) as Node;\n      mapNode.parent = this.mapManager.node;\n      if (cb) {\n        cb();\n      }\n\n      this._progress = 0;\n      this._reset();\n      this.loadingUI.finishLoading();\n    })\n\n\n  }\n\n  private _loadingSchedule() {\n    if (this._progress < 0) {\n      return;\n    }\n\n    this._progress--;\n    CustomEventListener.dispatchEvent(Constants.EventName.UPDATE_PROGRESS, 40 / 5);\n    this.scheduleOnce(this._loadingSchedule, 0.2);\n  }\n}\n\n"]}