{"version":3,"sources":["file:///Users/qinx/coding/cocos2dx/Cocos2dx-taxi/assets/script/game/CustomerManager.ts"],"names":["_decorator","Component","Node","Vec3","AnimationComponent","Constants","CustomEventListener","RunTimeData","AudioManager","ccclass","property","EventName","_tempVec","CustomerManager","type","CustomerState","NONE","start","on","GREETING","_greetingCustomer","GOODBYE","_takingCustomer","update","dt","_inTheOrder","_deltaTime","walkTime","_curCustomer","active","_state","playSound","AudioSource","INCAR","dispatchEvent","SHOW_GUIDE","FINISHID_WALK","lerp","_startPos","_endPos","setWorldPosition","_customerID","Math","floor","random","customers","length","carPos","direction","multiplyScalar","add","x","eulerAngles","z","animComp","getComponent","play","SHOW_TALK","NEWORDER","runtimeData","instance","money","currLevel","GETMONEY"],"mappings":"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","sourcesContent":["\nimport { _decorator, Component, Node, Vec3, AnimationComponent, TERRAIN_HEIGHT_BASE } from 'cc';\nimport { Constants } from '../data/Constants';\nimport { CustomEventListener } from '../data/CustomEventListener';\nimport { RunTimeData } from '../data/GameData';\nimport { AudioManager } from './AudioManager';\nconst { ccclass, property } = _decorator;\n\nconst EventName = Constants.EventName;\nconst _tempVec = new Vec3()\n\n@ccclass('CustomerManager')\nexport class CustomerManager extends Component {\n\n  @property({\n    type: [Node]\n  })\n  customers: Node[] = [];\n\n  @property\n  walkTime = 2;\n\n  private _curCustomer: Node | null = null;\n  private _startPos = new Vec3();\n  private _endPos = new Vec3();\n  private _inTheOrder = false;\n  private _deltaTime = 0;\n  private _state = Constants.CustomerState.NONE;\n  private _customerID = -1;\n\n  public start() {\n    CustomEventListener.on(EventName.GREETING, this._greetingCustomer, this);\n    CustomEventListener.on(EventName.GOODBYE, this._takingCustomer, this);\n  }\n\n  public update(dt: number) {\n    if (this._inTheOrder) {\n      this._deltaTime += dt;\n      if (this._deltaTime > this.walkTime) {\n        this._deltaTime = 0;\n        this._inTheOrder = false;\n        this._curCustomer!.active = false;\n        if (this._state == Constants.CustomerState.GOODBYE) {\n          this._curCustomer = null;\n        }\n\n        if (this._state === Constants.CustomerState.GREETING) {\n          AudioManager.playSound(Constants.AudioSource.INCAR);\n        }\n\n        CustomEventListener.dispatchEvent(Constants.EventName.SHOW_GUIDE, true);\n\n        CustomEventListener.dispatchEvent(EventName.FINISHID_WALK);\n      } else {\n        Vec3.lerp(_tempVec, this._startPos, this._endPos, this._deltaTime / this.walkTime)\n        this._curCustomer?.setWorldPosition(_tempVec);\n      }\n    }\n  }\n\n  private _greetingCustomer(...args: any[]) {\n    this._customerID = Math.floor(Math.random() * this.customers.length)\n    this._curCustomer = this.customers[this._customerID];\n    this._state = Constants.CustomerState.GREETING;\n    this._inTheOrder = true;\n    if (!this.customers) {\n      return;\n    }\n\n    const carPos = args[0];\n    const direction = args[1];\n    Vec3.multiplyScalar(this._startPos, direction, 1.4);\n    this._startPos.add(carPos)\n    Vec3.multiplyScalar(this._endPos, direction, 0.5);\n    this._endPos.add(carPos)\n\n    this._curCustomer.setWorldPosition(this._startPos);\n    this._curCustomer.active = true\n\n    if (direction.x !== 0) {\n      // 设置朝向\n      if (direction.x > 0) {\n        this._curCustomer.eulerAngles = new Vec3(0, -90, 0);\n      } else {\n        this._curCustomer.eulerAngles = new Vec3(0, 90, 0);\n      }\n    } else {\n      if (direction.z > 0) {\n        this._curCustomer.eulerAngles = new Vec3(0, 180, 0);\n      } else {\n        this._curCustomer.eulerAngles = new Vec3();\n      }\n    }\n\n    const animComp = this._curCustomer.getComponent(AnimationComponent);\n    animComp.play('walk');\n\n    CustomEventListener.dispatchEvent(EventName.SHOW_TALK, this._customerID);\n    AudioManager.playSound(Constants.AudioSource.NEWORDER);\n  }\n\n  private _takingCustomer(...args: any[]) {\n    this._state = Constants.CustomerState.GOODBYE;\n    this._inTheOrder = true;\n\n    const carPos = args[0];\n    const direction = args[1];\n    Vec3.multiplyScalar(this._startPos, direction, 0.5);\n    this._startPos.add(carPos)\n    Vec3.multiplyScalar(this._endPos, direction, 1.4);\n    this._endPos.add(carPos)\n\n    this._curCustomer!.setWorldPosition(this._startPos);\n    this._curCustomer!.active = true\n    const runtimeData = RunTimeData.instance();\n    const money = Math.floor(30 + (runtimeData.currLevel / 2) + (Math.random() * 10));\n    runtimeData.money += money;\n\n    if (direction.x !== 0) {\n      // 设置朝向\n      if (direction.x > 0) {\n        this._curCustomer!.eulerAngles = new Vec3(0, 90, 0);\n      } else {\n        this._curCustomer!.eulerAngles = new Vec3(0, -90, 0);\n      }\n    } else {\n      if (direction.z > 0) {\n        this._curCustomer!.eulerAngles = new Vec3();\n      } else {\n        this._curCustomer!.eulerAngles = new Vec3(0, 180, 0);\n      }\n    }\n\n    const animComp = this._curCustomer!.getComponent(AnimationComponent);\n    animComp.play('walk');\n    AudioManager.playSound(Constants.AudioSource.GETMONEY);\n\n    this._customerID = -1;\n  }\n}\n\n\n"]}